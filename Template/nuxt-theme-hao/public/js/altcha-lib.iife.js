(function(o){"use strict";const l=new TextEncoder;function m(e){return[...new Uint8Array(e)].map(t=>t.toString(16).padStart(2,"0")).join("")}async function w(e,t){return crypto.subtle.digest(e.toUpperCase(),typeof t=="string"?l.encode(t):new Uint8Array(t))}async function g(e,t){return m(await w(e,t))}async function N(e,t,n){const r=await crypto.subtle.importKey("raw",l.encode(n),{name:"HMAC",hash:e},!1,["sign","verify"]);return crypto.subtle.sign("HMAC",r,typeof t=="string"?l.encode(t):new Uint8Array(t))}async function v(e,t,n){return m(await N(e,t,n))}function T(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}function p(e){const t=new Uint32Array(1);crypto.getRandomValues(t);const n=t[0]/4294967296;return Math.floor(n*e+1)}const D=1e6,H=12,S="SHA-256";async function h(e){const t=e.algorithm||S,n=e.maxnumber||e.maxNumber||D,r=e.saltLength||H,a=new URLSearchParams(e.params);e.expires&&a.set("expires",String(Math.floor(e.expires.getTime()/1e3)));let s=e.salt||m(T(r));Object.keys(Object.fromEntries(a)).length&&(s=s+"?"+a.toString());const i=e.number===void 0?p(n):e.number,u=await g(t,s+i);return{algorithm:t,challenge:u,maxnumber:n,salt:s,signature:await v(t,u,e.hmacKey)}}function b(e){var t,n;return typeof e=="string"&&(e=JSON.parse(atob(e))),Object.fromEntries(new URLSearchParams(((n=(t=e==null?void 0:e.salt)==null?void 0:t.split("?"))==null?void 0:n[1])||""))}async function y(e,t,n=!0){if(typeof e=="string")try{e=JSON.parse(atob(e))}catch{return!1}const r=b(e),a=r.expires||r.expire;if(n&&a){const i=new Date(parseInt(a,10)*1e3);if(Number.isNaN(i.getTime())||i.getTime()<Date.now())return!1}const s=await h({algorithm:e.algorithm,hmacKey:t,number:e.number,salt:e.salt});return s.challenge===e.challenge&&s.signature===e.signature}async function A(e,t,n,r=S){const a=e instanceof FormData?Object.fromEntries(e):e,s=[];for(const i of t)s.push(String(a[i]||""));return await g(r,s.join(`
`))===n}async function M(e,t){var a,s;if(typeof e=="string")try{e=JSON.parse(atob(e))}catch{return{verificationData:null,verified:!1}}const n=await v(e.algorithm,await w(e.algorithm,e.verificationData),t);let r=null;try{const i=new URLSearchParams(e.verificationData);r={...Object.fromEntries(i),expire:parseInt(i.get("expire")||"0",10),fields:(a=i.get("fields"))==null?void 0:a.split(","),reasons:(s=i.get("reasons"))==null?void 0:s.split(","),score:i.get("score")?parseFloat(i.get("score")||"0"):void 0,time:parseInt(i.get("time")||"0",10),verified:i.get("verified")==="true"}}catch{}return{verificationData:r,verified:e.verified===!0&&(r==null?void 0:r.verified)===!0&&r.expire>Math.floor(Date.now()/1e3)&&e.signature===n}}function d(e,t,n="SHA-256",r=1e6,a=0){const s=new AbortController,i=Date.now();return{promise:(async()=>{for(let f=a;f<=r;f+=1){if(s.signal.aborted)return null;if(await g(n,t+f)===e)return{number:f,took:Date.now()-i}}return null})(),controller:s}}async function x(e,t,n,r,a="SHA-256",s=1e6,i=0){const u=[];t=Math.max(1,Math.min(16,t));for(let c=0;c<t;c++)typeof e=="function"?u.push(e()):u.push(new Worker(e,{type:"module"}));const f=Math.ceil(s/t),U=await Promise.all(u.map((c,j)=>{const L=i+j*f;return new Promise(P=>{c.addEventListener("message",E=>{if(E.data)for(const C of u)C!==c&&C.postMessage({type:"abort"});P(E.data)}),c.postMessage({payload:{algorithm:a,challenge:n,max:L+f,salt:r,start:L},type:"work"})})}));for(const c of u)c.terminate();return U.find(c=>!!c)||null}const O={createChallenge:h,extractParams:b,solveChallenge:d,solveChallengeWorkers:x,verifyFieldsHash:A,verifyServerSignature:M,verifySolution:y};o.createChallenge=h,o.default=O,o.extractParams=b,o.solveChallenge=d,o.solveChallengeWorkers=x,o.verifyFieldsHash=A,o.verifyServerSignature=M,o.verifySolution=y,Object.defineProperties(o,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})})(this["altcha-lib"]=this["altcha-lib"]||{});
